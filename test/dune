; ============================================================
; Test Environment Configuration
; Force filesystem backend to avoid external DB connection timeouts
; ============================================================
(env
 (_
  (env-vars
   (MASC_STORAGE_TYPE filesystem))))

; ============================================================
; Pure synchronous tests
; ============================================================
(tests
 (names test_room test_types test_checkpoint test_auth test_http_negotiation
        test_sse test_encryption test_backend test_cancellation test_graphql_api
        test_subscriptions test_session test_progress test_mitosis test_spawn
        test_validation test_response test_voice_stream test_sctp
        test_datachannel_rfc test_dtls_crypto test_dashboard
        test_multi_room test_worktree_detection test_bounded test_mention test_hat)
 (modules test_room test_types test_checkpoint test_auth test_http_negotiation
          test_sse test_encryption test_backend test_cancellation test_graphql_api
          test_subscriptions test_session test_progress test_mitosis test_spawn
          test_validation test_response test_voice_stream test_sctp
          test_datachannel_rfc test_dtls_crypto test_dashboard
          test_multi_room test_worktree_detection test_bounded test_mention test_hat)
 (libraries masc_mcp mcp_protocol alcotest str yojson mirage-crypto
            mirage-crypto-rng cohttp cstruct))

; ============================================================
; Eio module tests (Pure sync - Cache_eio, Metrics_store_eio, Hebbian_eio)
; ============================================================
(test
 (name test_cache_eio)
 (modules test_cache_eio)
 (libraries masc_mcp alcotest str yojson))

(test
 (name test_metrics_store_eio)
 (modules test_metrics_store_eio)
 (libraries masc_mcp alcotest str yojson))

(test
 (name test_hebbian_eio)
 (modules test_hebbian_eio)
 (libraries masc_mcp alcotest str yojson))

(test
 (name test_planning_eio)
 (modules test_planning_eio)
 (libraries masc_mcp alcotest str yojson))

; Mention module monkey/fuzz test
(executable
 (name test_mention_monkey)
 (modules test_mention_monkey)
 (libraries masc_mcp unix str))

; ============================================================
; Eio-native working tests (Mcp_server_eio, Session_eio)
; ============================================================
(test
 (name test_mcp_server_eio)
 (modules test_mcp_server_eio)
 (libraries masc_mcp alcotest eio eio_main yojson))

; DataChannel Eio test (DCEP + SCTP integration)
(test
 (name test_datachannel_eio)
 (modules test_datachannel_eio)
 (libraries masc_mcp alcotest eio eio_main yojson))

; Ralph Eio test (Production-ready fiber-safe Ralph)
(test
 (name test_walph_eio)
 (modules test_walph_eio)
 (libraries masc_mcp alcotest eio eio_main yojson))

; TODO: These tests need to be created
; - test_dtls_eio
; - test_sctp_eio
; - test_webrtc_stack_eio

; ============================================================
; Eio-native tests (OCaml 5.x concurrency)
; ============================================================

; Backend_eio test (Eio-native storage backend)
(test
 (name test_backend_eio)
 (modules test_backend_eio)
 (libraries masc_mcp alcotest eio eio_main fmt yojson))

; Session locking test (Eio concurrency)
(test
 (name test_session_locking)
 (modules test_session_locking)
 (libraries masc_mcp alcotest eio eio_main yojson))

; Room_eio test (Eio-native room operations)
(test
 (name test_room_eio)
 (modules test_room_eio)
 (libraries masc_mcp alcotest eio eio_main fmt yojson))

; Http_server_eio test (Compact Protocol v4 compression)
(test
 (name test_http_server_eio)
 (modules test_http_server_eio)
 (libraries masc_mcp alcotest eio eio_main httpun zstd yojson))

; Compression tests (Compact Protocol v4 - Backend_eio, DataChannel)
(test
 (name test_compression)
 (modules test_compression)
 (libraries masc_mcp alcotest zstd))

; PostgreSQL Pub/Sub LISTEN/NOTIFY test
(test
 (name test_pubsub_postgres)
 (modules test_pubsub_postgres)
 (libraries masc_mcp alcotest))

; ============================================================
; Concurrency stress tests (20+ agents)
; Phase 4: MCP Unify project
; ============================================================
(test
 (name test_concurrency_stress)
 (modules test_concurrency_stress)
 (libraries masc_mcp alcotest eio eio_main yojson))

; ============================================================
; A2A (Agent-to-Agent) E2E Tests
; Validates TLA+ specification in docs/MASC_A2A.tla
; ============================================================
(test
 (name test_a2a_e2e)
 (modules test_a2a_e2e)
 (libraries masc_mcp alcotest eio eio_main yojson))

; A2A Distributed Test (2-process sequential communication)
; Run with: ./scripts/test_distributed.sh
(executable
 (name test_a2a_distributed)
 (modules test_a2a_distributed)
 (libraries masc_mcp eio eio_main yojson unix))

; A2A Concurrent Distributed Test (TRUE parallel writes)
; Run with: ./scripts/test_concurrent.sh
(executable
 (name test_concurrent_distributed)
 (modules test_concurrent_distributed)
 (libraries masc_mcp eio eio_main str yojson unix))

; ============================================================
; Disabled: Lwt-based tests (require cohttp-lwt-unix, ppx_lwt)
; These modules are not currently in masc_mcp library.
; ============================================================
; (test
;  (name test_voice_bridge)
;  (modules test_voice_bridge)
;  (libraries masc_mcp alcotest lwt lwt.unix cohttp-lwt-unix yojson))
;
; (test
;  (name test_webrtc_datachannel)
;  (modules test_webrtc_datachannel)
;  (libraries masc_mcp alcotest lwt lwt.unix))
(executable
 (name test_atomic_simple)
 (modules test_atomic_simple)
 (libraries masc_mcp eio eio_main))

; ============================================================
; Benchmarks (local, reproducible)
; ============================================================
(executables
 (names
   bench_udp_fair
   bench_udp_throughput
   bench_udp_oneway
   bench_sctp_transport
   bench_sctp_batch
   bench_burst_send)
 (modules
   bench_udp_fair
   bench_udp_throughput
   bench_udp_oneway
   bench_sctp_transport
   bench_sctp_batch
   bench_burst_send)
 (libraries masc_mcp eio eio_main mtime mtime.clock))

; ============================================================
; Coverage tests (generated by Agent Autonomy)
; ============================================================
(tests
 (names test_backend_coverage test_tools_coverage test_types_utils_coverage test_sdp_coverage test_agent_card_coverage test_misc_coverage test_mode_coverage test_relay_coverage test_tempo_coverage test_federation_coverage test_mitosis_coverage test_transport_coverage test_validation_coverage test_encryption_coverage test_dashboard_resilience_coverage test_log_coverage test_nickname_coverage test_level2_config_coverage test_compression_dict_coverage test_checkpoint_types_coverage test_config_coverage test_env_config_coverage test_progress_coverage test_mcp_protocol_coverage test_notify_coverage test_mcp_session_coverage test_subscriptions_coverage test_sse_coverage test_credits_dashboard_coverage test_room_utils_coverage test_orchestrator_coverage test_cancellation_coverage test_web_dashboard_coverage test_auth_coverage test_a2a_tools_coverage test_graphql_api_coverage test_mention_coverage test_response_coverage test_resilience_coverage test_level4_config_coverage test_datachannel_coverage test_dtls_coverage test_error_coverage test_webrtc_common_coverage test_sctp_coverage test_hat_coverage test_types_coverage test_spawn_coverage test_dashboard_coverage test_rate_limit_coverage test_bounded_coverage test_dtls_crypto_coverage test_void_coverage test_webrtc_bindings_coverage test_gcm_compat_coverage test_masc_pb_coverage test_transport_grpc_next_coverage test_sctp_transport_coverage test_session_coverage test_cache_eio_coverage test_hebbian_eio_coverage test_metrics_store_eio_coverage test_voice_stream_coverage test_planning_eio_coverage test_room_portal_coverage test_run_eio_coverage test_handover_eio_coverage test_swarm_eio_coverage test_datachannel_eio_coverage test_backend_eio_coverage test_mcp_server_eio_coverage test_spawn_eio_coverage test_http_server_eio_coverage test_swarm_behaviors_eio_coverage test_telemetry_eio_coverage test_room_git_coverage test_llm_client_eio_coverage test_llm_client_coverage test_prometheus_coverage test_auto_responder_coverage test_mind_eio_coverage test_noosphere_eio_coverage test_tool_swarm_coverage test_tool_plan_coverage test_tool_run_coverage test_tool_cache_coverage test_tool_tempo_coverage test_tool_mitosis_coverage)
 (modules test_backend_coverage test_tools_coverage test_types_utils_coverage test_sdp_coverage test_agent_card_coverage test_misc_coverage test_mode_coverage test_relay_coverage test_tempo_coverage test_federation_coverage test_mitosis_coverage test_transport_coverage test_validation_coverage test_encryption_coverage test_dashboard_resilience_coverage test_log_coverage test_nickname_coverage test_level2_config_coverage test_compression_dict_coverage test_checkpoint_types_coverage test_config_coverage test_env_config_coverage test_progress_coverage test_mcp_protocol_coverage test_notify_coverage test_mcp_session_coverage test_subscriptions_coverage test_sse_coverage test_credits_dashboard_coverage test_room_utils_coverage test_orchestrator_coverage test_cancellation_coverage test_web_dashboard_coverage test_auth_coverage test_a2a_tools_coverage test_graphql_api_coverage test_mention_coverage test_response_coverage test_resilience_coverage test_level4_config_coverage test_datachannel_coverage test_dtls_coverage test_error_coverage test_webrtc_common_coverage test_sctp_coverage test_hat_coverage test_types_coverage test_spawn_coverage test_dashboard_coverage test_rate_limit_coverage test_bounded_coverage test_dtls_crypto_coverage test_void_coverage test_webrtc_bindings_coverage test_gcm_compat_coverage test_masc_pb_coverage test_transport_grpc_next_coverage test_sctp_transport_coverage test_session_coverage test_cache_eio_coverage test_hebbian_eio_coverage test_metrics_store_eio_coverage test_voice_stream_coverage test_planning_eio_coverage test_room_portal_coverage test_run_eio_coverage test_handover_eio_coverage test_swarm_eio_coverage test_datachannel_eio_coverage test_backend_eio_coverage test_mcp_server_eio_coverage test_spawn_eio_coverage test_http_server_eio_coverage test_swarm_behaviors_eio_coverage test_telemetry_eio_coverage test_room_git_coverage test_llm_client_eio_coverage test_llm_client_coverage test_prometheus_coverage test_auto_responder_coverage test_mind_eio_coverage test_noosphere_eio_coverage test_tool_swarm_coverage test_tool_plan_coverage test_tool_run_coverage test_tool_cache_coverage test_tool_tempo_coverage test_tool_mitosis_coverage)
 (libraries masc_mcp alcotest eio eio_main str yojson zstd mirage-crypto-rng.unix cstruct ocaml-protoc-plugin))
